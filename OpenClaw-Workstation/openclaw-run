#!/usr/bin/with-contenv bash
set -e

# S6 Service Run Script for OpenClaw Gateway
# This script is supervised by S6. It runs in the foreground.

log() {
  echo "[$(date +'%Y-%m-%dT%H:%M:%S%z')] $1"
}

log "ü¶û OpenClaw Service Starting..."
log "üë§ User: $(whoami) (UID: $(id -u))"
log "üè† HOME: $HOME"

CONFIG_DIR="/config/.openclaw"
CONFIG_FILE="$CONFIG_DIR/openclaw.json"
LOG_DIR="$CONFIG_DIR/logs"
LOG_FILE="$LOG_DIR/openclaw.log"
AGENT_DIR="$CONFIG_DIR/agents/main/agent"
AUTH_FILE="$AGENT_DIR/auth-profiles.json"
CREDENTIALS_DIR="$CONFIG_DIR/credentials"

mkdir -p "$CONFIG_DIR"
mkdir -p "$LOG_DIR"
mkdir -p "$AGENT_DIR"
mkdir -p "$CREDENTIALS_DIR"

# Ensure config is accessible securely
# We don't need complex symlinks if we force HOME=/config correctly,
# but keeping them doesn't hurt for other tools.
if [ "$CONFIG_DIR" != "/root/.openclaw" ]; then
  mkdir -p /root
  ln -sfn "$CONFIG_DIR" /root/.openclaw
fi

if [ -d "/config" ] && [ "$CONFIG_DIR" != "/config/.openclaw" ]; then
   ln -sfn "$CONFIG_DIR" /config/.openclaw
fi

# Determine Gateway Token
# Priority: 1. ENV, 2. Existing Config, 3. New Generation
if [ -n "$OPENCLAW_TOKEN" ] && [ -z "$OPENCLAW_GATEWAY_TOKEN" ]; then
  OPENCLAW_GATEWAY_TOKEN="$OPENCLAW_TOKEN"
fi

if [ -z "$OPENCLAW_GATEWAY_TOKEN" ] && [ -f "$CONFIG_FILE" ]; then
  OPENCLAW_GATEWAY_TOKEN=$(jq -r '.gateway.auth.token // empty' "$CONFIG_FILE")
  if [ -n "$OPENCLAW_GATEWAY_TOKEN" ]; then
    log "üîë Using existing auth token from config"
  fi
fi

if [ -z "$OPENCLAW_GATEWAY_TOKEN" ]; then
  OPENCLAW_GATEWAY_TOKEN=$(openssl rand -hex 32)
  log "üîê Generated new auth token: $OPENCLAW_GATEWAY_TOKEN"
fi

# Determine Trusted Proxies
# Priority: 1. ENV, 2. Existing Config, 3. Defaults
if [ -n "$OPENCLAW_GATEWAY_TRUSTED_PROXIES" ]; then
  PROXIES_JSON=$(echo "$OPENCLAW_GATEWAY_TRUSTED_PROXIES" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
elif [ -f "$CONFIG_FILE" ]; then
  PROXIES_JSON=$(jq -c '.gateway.trustedProxies // empty' "$CONFIG_FILE")
fi

if [ -z "$PROXIES_JSON" ] || [ "$PROXIES_JSON" = "null" ]; then
  PROXIES_JSON='["10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "127.0.0.1", "::1"]'
  log "‚ÑπÔ∏è Using default trusted proxies"
fi

# Determine default model
DEFAULT_MODEL="google/gemini-3-flash-preview"

if [ -n "$OPENCLAW_AGENT_MODEL" ]; then
  DEFAULT_MODEL="$OPENCLAW_AGENT_MODEL"
elif [ -n "$ANTHROPIC_API_KEY" ]; then
  DEFAULT_MODEL="anthropic/claude-sonnet-4-20250514"
elif [ -n "$OPENAI_API_KEY" ]; then
  DEFAULT_MODEL="openai/gpt-4o"
fi

log "ü¶û OpenClaw Configuration"
log "--------------------------------"
log "Trusted Proxies: $PROXIES_JSON"
log "Auth Token: $OPENCLAW_GATEWAY_TOKEN"
log "Default Model: $DEFAULT_MODEL"

# Determine Logging Strategy
# Priority: 1. ENV, 2. Existing Config, 3. Defaults
LOG_LEVEL="${OPENCLAW_LOG_LEVEL:-info}"
CONSOLE_LOG_LEVEL="${OPENCLAW_CONSOLE_LOG_LEVEL:-info}"

# Determine Log File Path
# If it exists in config and is NOT in /tmp, we keep it.
EXISTING_LOG_FILE=""
if [ -f "$CONFIG_FILE" ]; then
  EXISTING_LOG_FILE=$(jq -r '.logging.file // empty' "$CONFIG_FILE")
fi

if [[ -n "$EXISTING_LOG_FILE" ]] && [[ "$EXISTING_LOG_FILE" != /tmp/* ]]; then
  LOG_FILE_PATH="$EXISTING_LOG_FILE"
  log "üìù Using existing persistent log file: $LOG_FILE_PATH"
else
  LOG_FILE_PATH="/config/.openclaw/logs/openclaw.log"
  log "üìù Using default persistent log file: $LOG_FILE_PATH"
fi

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE_PATH")"

log "Log Level: $LOG_LEVEL (File) / $CONSOLE_LOG_LEVEL (Console)"
log "--------------------------------"

# Build channels config
CHANNELS_JSON=""

if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
  echo -n "$TELEGRAM_BOT_TOKEN" > "$CREDENTIALS_DIR/telegram-bot-token"
  CHANNELS_JSON="\"telegram\": { \"tokenFile\": \"$CREDENTIALS_DIR/telegram-bot-token\" }"
  echo "üì± Telegram channel configured"
fi

if [ -n "$DISCORD_BOT_TOKEN" ]; then
  echo -n "$DISCORD_BOT_TOKEN" > "$CREDENTIALS_DIR/discord-bot-token"
  if [ -n "$CHANNELS_JSON" ]; then CHANNELS_JSON="$CHANNELS_JSON,"; fi
  CHANNELS_JSON="$CHANNELS_JSON\"discord\": { \"tokenFile\": \"$CREDENTIALS_DIR/discord-bot-token\" }"
  echo "üì± Discord channel configured"
fi

if [ -n "$SLACK_BOT_TOKEN" ] && [ -n "$SLACK_APP_TOKEN" ]; then
  echo -n "$SLACK_BOT_TOKEN" > "$CREDENTIALS_DIR/slack-bot-token"
  echo -n "$SLACK_APP_TOKEN" > "$CREDENTIALS_DIR/slack-app-token"
  if [ -n "$CHANNELS_JSON" ]; then CHANNELS_JSON="$CHANNELS_JSON,"; fi
  CHANNELS_JSON="$CHANNELS_JSON\"slack\": { \"botTokenFile\": \"$CREDENTIALS_DIR/slack-bot-token\", \"appTokenFile\": \"$CREDENTIALS_DIR/slack-app-token\" }"
  echo "üì± Slack channel configured"
fi

# Initialize or merge gateway config
if [ ! -f "$CONFIG_FILE" ]; then
    log "üìÑ Creating initial gateway config..."
    cat > "$CONFIG_FILE" << EOF
{
  "gateway": {
    "trustedProxies": $PROXIES_JSON,
    "auth": {
      "mode": "token",
      "token": "$OPENCLAW_GATEWAY_TOKEN"
    }
  },
  "logging": {
    "file": "$LOG_FILE_PATH",
    "level": "$LOG_LEVEL",
    "consoleLevel": "$CONSOLE_LOG_LEVEL"
  },
  "agents": {
    "defaults": { "model": { "primary": "$DEFAULT_MODEL" } },
    "list": [
      { "id": "main", "name": "OpenClaw", "subagents": { "allowAgents": ["architect", "security-auditor", "code-reviewer", "ux-manager"] } },
      { "id": "architect", "name": "Architect", "identity": { "name": "Architect", "emoji": "üèõÔ∏è" }, "tools": { "profile": "coding", "deny": ["browser", "message"] } },
      { "id": "security-auditor", "name": "Security Auditor", "identity": { "name": "Security Auditor", "emoji": "üîí" }, "tools": { "profile": "coding", "deny": ["browser", "message"] } },
      { "id": "code-reviewer", "name": "Code Reviewer", "identity": { "name": "Code Reviewer", "emoji": "üìù" }, "tools": { "profile": "coding", "deny": ["browser", "message"] } },
      { "id": "ux-manager", "name": "UX Manager", "identity": { "name": "UX Manager", "emoji": "üé®" }, "tools": { "profile": "coding", "deny": ["message"] } }
    ]
  }
}
EOF
else
    log "üìÑ Merging environment updates into existing config..."
    # Update gateway settings and logging using safer jq --arg
    jq --arg token "$OPENCLAW_GATEWAY_TOKEN" \
       --arg logFile "$LOG_FILE_PATH" \
       --arg logLevel "$LOG_LEVEL" \
       --arg consoleLevel "$CONSOLE_LOG_LEVEL" \
       --argproxies "$PROXIES_JSON" \
       '.gateway.trustedProxies = ($argproxies | fromjson) | 
        .gateway.auth.token = $token | 
        .logging.file = $logFile | 
        .logging.level = $logLevel | 
        .logging.consoleLevel = $consoleLevel' \
        "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
    
    # Update default model if set
    jq --arg model "$DEFAULT_MODEL" ".agents.defaults.model.primary = \$model" "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
fi

# Update channels if environment variables are provided
# Note: This updates the config if the ENV is set, but won't delete existing config if ENV is missing
if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
    log "üì± Configuring Telegram from ENV..."
    jq ".channels.telegram = { \"enabled\": true, \"botToken\": \"$TELEGRAM_BOT_TOKEN\", \"dmPolicy\": \"pairing\", \"groupPolicy\": \"allowlist\", \"streamMode\": \"partial\" }" "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
fi

if [ -n "$DISCORD_BOT_TOKEN" ]; then
    log "üì± Configuring Discord from ENV..."
    jq ".channels.discord = { \"enabled\": true, \"botToken\": \"$DISCORD_BOT_TOKEN\" }" "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
fi

log "‚úÖ Gateway config updated/verified at $CONFIG_FILE"

# Create agent auth-profiles.json
echo "üîë Configuring agent API keys..."

AUTH_JSON='{"profiles":{'

if [ -n "$ANTHROPIC_API_KEY" ]; then
  AUTH_JSON="${AUTH_JSON}\"anthropic\":{\"apiKey\":\"$ANTHROPIC_API_KEY\"},"
  echo "   ‚úì Anthropic API key configured"
fi

if [ -n "$GEMINI_API_KEY" ]; then
  AUTH_JSON="${AUTH_JSON}\"google\":{\"apiKey\":\"$GEMINI_API_KEY\"},"
  echo "   ‚úì Google/Gemini API key configured"
fi

if [ -n "$OPENAI_API_KEY" ]; then
  AUTH_JSON="${AUTH_JSON}\"openai\":{\"apiKey\":\"$OPENAI_API_KEY\"},"
  echo "   ‚úì OpenAI API key configured"
fi

AUTH_JSON="${AUTH_JSON%,}}}"

echo "$AUTH_JSON" > "$AUTH_FILE"
log "‚úÖ Agent auth config created at $AUTH_FILE"

# Fix permissions so that the Desktop user (abc/911) can read the config
# This is crucial so that local apps can discover the token
log "üîß Setting permissions on $CONFIG_DIR..."
chown -R 911:911 "$CONFIG_DIR" || log "‚ö†Ô∏è Failed to chown $CONFIG_DIR (ignoring)"
chmod -R 755 "$CONFIG_DIR"

log ""
log "üöÄ Starting OpenClaw Gateway on port 18789..."
log "üìÇ Configuration File Content:"
cat "$CONFIG_FILE"
log ""

# S6 Service Execution
cd /opt/openclaw

# Ensure HOME is correctly set for the persistent user environment
export HOME=/config
log "üè† HOME set to: $HOME"

log "üõ†Ô∏è Executing node process (Supervised by S6)..."

# Exec replaces the shell process with node, allowing signals to propagate
# Using exec ensures S6 monitors the actual node process

# DEBUG LOGGING
export DEBUG="openclaw:*"

# FORCE DISABLE DEVICE AUTH
# We export these in multiple formats to hit the right config path
# export OPENCLAW_GATEWAY__CONTROL_UI__DANGEROUSLY_DISABLE_DEVICE_AUTH="true"
# export OPENCLAW_GATEWAY__AUTH__DANGEROUSLY_DISABLE_DEVICE_AUTH="true"

log "üîß Debug logging enabled (DEBUG=openclaw:*)"
log "üîì Force-disabling device auth checks via ENV"

exec node dist/index.js gateway --bind lan --allow-unconfigured

